{"ID":"cb79428b-68b5-4e64-b570-e52add18e7eb","VersionNumber":7,"Name":"Tables Approaching Maximum Number of Table Partitions","Description":"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n\t<head>\r\n\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title>\r\n\t\t</title>\r\n\t\t<style type=\"text/css\">\r\n\t\t\t.cs2654AE3A{text-align:left;text-indent:0pt;margin:0pt 0pt 0pt 0pt}\r\n\t\t\t.csBEC5BAA2{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.csE19E36D{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:italic;}\r\n\t\t\t.csF6EF92FE{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:bold;font-style:normal;}\r\n\t\t\t.csF1E20DCD{color:#0000FF;background-color:#FFFFFF;font-family:Consolas;font-size:9.5pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.csFB6D2A79{color:#000000;background-color:#FFFFFF;font-family:Consolas;font-size:9.5pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.csE7A62AA1{color:#808080;background-color:#FFFFFF;font-family:Consolas;font-size:9.5pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.cs768924CD{color:#00FF00;background-color:#FFFFFF;font-family:Consolas;font-size:9.5pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.cs1A94D079{color:#FF00FF;background-color:#FFFFFF;font-family:Consolas;font-size:9.5pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.cs6BD174F1{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: none;}\r\n\t\t\t.csC1A17A41{color:#0000FF;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: underline;}\r\n\t\t</style>\r\n\t</head>\r\n\t<body>\r\n\t\t<p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">This condition evaluates to </span><span class=\"csE19E36D\">True</span><span class=\"csBEC5BAA2\"> when it finds databases with tables that have a number of partitions that is greater than 14,500. Current versions of SQL Server support 15,000 partitions maximum, and versions prior to 2012 support up to 1,000. Current versions of SQL Server may experience performance issues when there are more than 1,000 partitions (as explained in the Microsoft Docs article listed below).</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">The results returned are number of tables in a database that meet the condition (</span><span class=\"csF6EF92FE\">Value</span><span class=\"csBEC5BAA2\">) and the name of the database that has the tables (</span><span class=\"csF6EF92FE\">Key</span><span class=\"csBEC5BAA2\">).</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">If the condition evaluates to </span><span class=\"csE19E36D\">True</span><span class=\"csBEC5BAA2\">, run the following query against the database(s) in the result set to get a list of all tables meeting the condition and the number of partitions in each:</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">SELECT</span><span class=\"csFB6D2A79\"> </span><span class=\"csF1E20DCD\">DISTINCT</span><span class=\"csFB6D2A79\"> [t]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[name]</span><span class=\"csE7A62AA1\">,</span><span class=\"csFB6D2A79\"> [p]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[partition_number]</span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">FROM</span><span class=\"csFB6D2A79\"> </span><span class=\"cs768924CD\">sys</span><span class=\"csE7A62AA1\">.</span><span class=\"cs768924CD\">partitions</span><span class=\"csFB6D2A79\"> p </span><span class=\"csF1E20DCD\">WITH </span><span class=\"csE7A62AA1\">(</span><span class=\"csF1E20DCD\">NOLOCK</span><span class=\"csE7A62AA1\">)</span><span class=\"csFB6D2A79\"> </span></p><p class=\"cs2654AE3A\"><span class=\"csE7A62AA1\">INNER</span><span class=\"csFB6D2A79\"> </span><span class=\"csE7A62AA1\">JOIN</span><span class=\"csFB6D2A79\"> </span><span class=\"cs768924CD\">sys</span><span class=\"csE7A62AA1\">.</span><span class=\"cs768924CD\">tables</span><span class=\"csFB6D2A79\"> t </span><span class=\"csF1E20DCD\">WITH </span><span class=\"csE7A62AA1\">(</span><span class=\"csF1E20DCD\">NOLOCK</span><span class=\"csE7A62AA1\">)</span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">ON</span><span class=\"csFB6D2A79\"> p</span><span class=\"csE7A62AA1\">.</span><span class=\"cs1A94D079\">object_id</span><span class=\"csFB6D2A79\"> </span><span class=\"csE7A62AA1\">=</span><span class=\"csFB6D2A79\"> t</span><span class=\"csE7A62AA1\">.</span><span class=\"cs1A94D079\">object_id</span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">WHERE</span><span class=\"csFB6D2A79\"> [p]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[partition_number] </span><span class=\"csE7A62AA1\">=</span><span class=\"csF1E20DCD\"> </span><span class=\"csE7A62AA1\">(</span><span class=\"csF1E20DCD\">SELECT</span><span class=\"csFB6D2A79\"> </span><span class=\"cs1A94D079\">MAX</span><span class=\"csE7A62AA1\">(</span><span class=\"csFB6D2A79\">[sp]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[partition_number]</span><span class=\"csE7A62AA1\">)</span><span class=\"csFB6D2A79\"> </span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">FROM</span><span class=\"csFB6D2A79\"> </span><span class=\"cs768924CD\">sys</span><span class=\"csE7A62AA1\">.</span><span class=\"cs768924CD\">partitions</span><span class=\"csFB6D2A79\"> sp </span><span class=\"csF1E20DCD\">WITH </span><span class=\"csE7A62AA1\">(</span><span class=\"csF1E20DCD\">NOLOCK</span><span class=\"csE7A62AA1\">)</span><span class=\"csFB6D2A79\"> </span></p><p class=\"cs2654AE3A\"><span class=\"csF1E20DCD\">WHERE</span><span class=\"csFB6D2A79\"> [sp]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[object_id] </span><span class=\"csE7A62AA1\">=</span><span class=\"csFB6D2A79\"> [t]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[object_id] </span></p><p class=\"cs2654AE3A\"><span class=\"csE7A62AA1\">AND</span><span class=\"csFB6D2A79\"> [sp]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[partition_number] </span><span class=\"csE7A62AA1\">&gt;</span><span class=\"csFB6D2A79\"> 14500</span><span class=\"csE7A62AA1\">)</span></p><p class=\"cs2654AE3A\"><span class=\"csE7A62AA1\">AND</span><span class=\"csFB6D2A79\"> [p]</span><span class=\"csE7A62AA1\">.</span><span class=\"csFB6D2A79\">[partition_number] </span><span class=\"csE7A62AA1\">&gt;</span><span class=\"csFB6D2A79\"> 14500</span><span class=\"csE7A62AA1\">;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csF6EF92FE\">See Also</span><span class=\"csBEC5BAA2\">:</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\"><a class=\"cs6BD174F1\" href=\"https://docs.microsoft.com/en-us/sql/relational-databases/partitions/partitioned-tables-and-indexes\"><span class=\"csC1A17A41\">https://docs.microsoft.com/en-us/sql/relational-databases/partitions/partitioned-tables-and-indexes</span></a></span><span class=\"csBEC5BAA2\">&nbsp;</span></p></body>\r\n</html>\r\n","AppliesToObjectTypeID":"0a11a887-823a-4461-87af-321cad1c3623","ConditionCategoryID":"805a84c9-7f1b-4b4d-a9ad-3dddcf9e0f17","OwnerObjectID":"b7c74f24-1a45-4115-8262-d7613878bbd6","OwnerObjectTypeID":"894de672-3fc0-4779-9a0d-880d4c207c77","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"aa61ee90-8a95-4fdf-a208-b9a4afa26d9d\",\"Database\":\"master\",\"Query\":\"DECLARE @sql nvarchar(max);\\r\\nSET @sql = N'';\\r\\nSELECT @sql = @sql + N'UNION ALL \\r\\n  SELECT DatabaseName = N''' + name + ''' COLLATE Latin1_General_BIN, \\r\\n  NumberOfTablesWithHighPartitions =  \\r\\n  (\\r\\n    SELECT COUNT(*) as NumberOfTablesWithHighPartitions\\r\\n      FROM ' + QUOTENAME(name) + '.sys.partitions p WITH (NOLOCK) \\r\\n   INNER JOIN ' + QUOTENAME(name) + '.sys.tables t WITH (NOLOCK)\\r\\n  ON p.object_id = t.object_id'\\r\\n   + N'\\r\\n      WHERE [p].[partition_number] = (SELECT MAX([sp].[partition_number]) \\r\\nFROM sys.partitions sp WITH (NOLOCK) \\r\\nWHERE [sp].[object_id] = [t].[object_id] \\r\\nAND [sp].[partition_number] > 14500)\\r\\nAND [p].[partition_number] > 14500\\r\\n  )\\r\\n  ' FROM sys.databases \\r\\nWHERE database_id > 4 AND state = 0;\\r\\n\\r\\nSET @sql = N'SELECT DatabaseName, NumberOfTablesWithHighPartitions FROM \\r\\n(' + STUFF(@sql, 1, 10, N'') \\r\\n   + N') AS x \\r\\n   WHERE NumberOfTablesWithHighPartitions > 0\\r\\n   ORDER BY NumberOfTablesWithHighPartitions DESC';\\r\\n\\r\\nEXEC sys.sp_executesql @sql;\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"0\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","EvaluationFrequency":"1.00:00:00","IdlePeriod":"00:00:00","MaximumAllowedDuration":"00:00:30","AntiConditionID":"790c9df6-018e-4758-8530-c8efbd69eadc","MinWindowsVersion":null,"MaxWindowsVersion":null,"MinSQLServerVersion":"11.0","MaxSQLServerVersion":null,"MinSSASVersion":null,"MaxSSASVersion":null,"MinVmwareVersion":null,"MaxVmwareVersion":null,"MinSqlDbVersion":null,"MaxSqlDbVersion":null,"MaximumInstanceCount":100,"ColorIndicator":null,"Severity":1,"Signature":{"ConditionID":"cb79428b-68b5-4e64-b570-e52add18e7eb","VersionNumber":7,"AppliesToObjectTypeID":"0a11a887-823a-4461-87af-321cad1c3623","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"aa61ee90-8a95-4fdf-a208-b9a4afa26d9d\",\"Database\":\"master\",\"Query\":\"DECLARE @sql nvarchar(max);\\r\\nSET @sql = N'';\\r\\nSELECT @sql = @sql + N'UNION ALL \\r\\n  SELECT DatabaseName = N''' + name + ''' COLLATE Latin1_General_BIN, \\r\\n  NumberOfTablesWithHighPartitions =  \\r\\n  (\\r\\n    SELECT COUNT(*) as NumberOfTablesWithHighPartitions\\r\\n      FROM ' + QUOTENAME(name) + '.sys.partitions p WITH (NOLOCK) \\r\\n   INNER JOIN ' + QUOTENAME(name) + '.sys.tables t WITH (NOLOCK)\\r\\n  ON p.object_id = t.object_id'\\r\\n   + N'\\r\\n      WHERE [p].[partition_number] = (SELECT MAX([sp].[partition_number]) \\r\\nFROM sys.partitions sp WITH (NOLOCK) \\r\\nWHERE [sp].[object_id] = [t].[object_id] \\r\\nAND [sp].[partition_number] > 14500)\\r\\nAND [p].[partition_number] > 14500\\r\\n  )\\r\\n  ' FROM sys.databases \\r\\nWHERE database_id > 4 AND state = 0;\\r\\n\\r\\nSET @sql = N'SELECT DatabaseName, NumberOfTablesWithHighPartitions FROM \\r\\n(' + STUFF(@sql, 1, 10, N'') \\r\\n   + N') AS x \\r\\n   WHERE NumberOfTablesWithHighPartitions > 0\\r\\n   ORDER BY NumberOfTablesWithHighPartitions DESC';\\r\\n\\r\\nEXEC sys.sp_executesql @sql;\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"0\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","PublisherID":0,"PublishDateUtc":"2020-08-04T19:12:54","Rights":0,"SignatureVersion":1,"SignaturePublicKey":"<RSAKeyValue><Modulus>uzJQ9gzevXFwOgw/hkcAtD+cA/bBbD1PRzhEZCxbZ6YwjJ1c9bbfXFItLQNwnm8bdWh2k57//qbpEj5DFHOW2EAjHc2Zw5m/vACm6OzelubPS5hbWvzshlaBJKm7KrpWQpPZClx/5eVvUVzOtlz+44RRTiOszObT58acJAQwA70=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>","Signature":"H3HBqU03op7nx5rHUeRcMz1yN/VRlHbiD1LqlbMYt+EehVJtX6mbfXX58DM84iBonOoT51NRfEsHf5I6cv86jGEQP0k2PqmDStx4SJvbO6W4WaUtBo3a8+GlBY1GcMvLs9fxb1YOyuBsScN7Y8B6/Y6MzKxVHUiVp3RAcjAkV9s=","IsSelfPublishedCondition":true},"Tags":"Performance,Auditing","Areas":[],"ConditionSystemVersion":3,"MinDBSchemaVersion":null,"MaxDBSchemaVersion":null,"Items":[]}