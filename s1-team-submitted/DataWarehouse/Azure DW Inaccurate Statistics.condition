{"ID":"de1eda9b-891b-4f7d-b51a-e5a684ddf570","VersionNumber":1,"Name":"Azure DW Inaccurate Statistics","Description":"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n\t<head>\r\n\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /><title>\r\n\t\t</title>\r\n\t\t<style type=\"text/css\">\r\n\t\t\t.cs2654AE3A{text-align:left;text-indent:0pt;margin:0pt 0pt 0pt 0pt}\r\n\t\t\t.csBEC5BAA2{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;}\r\n\t\t\t.cs6BD174F1{color:#000000;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: none;}\r\n\t\t\t.csC1A17A41{color:#0000FF;background-color:transparent;font-family:Tahoma;font-size:8pt;font-weight:normal;font-style:normal;text-decoration: underline;}\r\n\t\t</style>\r\n\t</head>\r\n\t<body>\r\n\t\t<p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">This advisory condition provides an effective way to determine if statistics are out of date by comparing row count estimates between the control node and the compute nodes for each table in a database.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">If the percentage values differ too greatly, Azure DW does not have accurate statistics for that table. This can cause the optimizer to choose operations and data movements that are not efficient and result in long query run times. </span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">By default, this condition will evaluate to true if there is at least 20% discrepancy on any table.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">When configuring for your environment be sure to import at the target level, not All Targets. Also be sure to update the Database name to the database you wish to evaluate.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">Note this condition only evaluates row counts and not cardinality. It also does not take into account whether statistics exist on more than one column, or for which column the statistics exist.</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">&nbsp;</span></p><p class=\"cs2654AE3A\"><span class=\"csBEC5BAA2\">For more info see: <a class=\"cs6BD174F1\" href=\"https://support.microsoft.com/en-us/help/3046875/how-to-evaluate-pdw-statistics-accuracy\"><span class=\"csC1A17A41\">https://support.microsoft.com/en-us/help/3046875/how-to-evaluate-pdw-statistics-accuracy</span></a></span></p></body>\r\n</html>\r\n","AppliesToObjectTypeID":"961ba39d-5ae1-4292-9bbd-dafc269da6a8","ConditionCategoryID":"805a84c9-7f1b-4b4d-a9ad-3dddcf9e0f17","OwnerObjectID":"1421cbfd-0935-4cf2-9a1c-377ab33e4df4","OwnerObjectTypeID":"961ba39d-5ae1-4292-9bbd-dafc269da6a8","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"b942fa0b-95e8-4dc8-8a0c-b4c6bc0ded34\",\"Database\":\"ContosoDW\",\"Query\":\"WITH Row_Counts_CTE\\r\\nAS\\r\\n \\r\\n(\\r\\nSELECT db_name() as [Database],\\r\\n   pdwtbl.name as [Table], \\r\\n    Sum(part.rows)/ max(pdwpart.partition_number)/8 AS CMP_ROW_COUNT, \\r\\n       sum(pdwpart.rows)/max(size.distribution_id)/max(pdwpart.partition_number)/8 AS CTL_ROW_COUNT ,\\r\\n     (Sum(part.rows)/ max(pdwpart.partition_number)/8) -  \\r\\n       (sum(pdwpart.rows)/max(size.distribution_id)/max(pdwpart.partition_number)/8) AS Count_Discrepancy \\r\\n   \\r\\nFROM   sys.pdw_nodes_partitions part \\r\\n       JOIN sys.pdw_nodes_tables tbl \\r\\n         ON part.object_id = tbl.object_id \\r\\n        AND part.pdw_node_id = tbl.pdw_node_id \\r\\n              JOIN sys.pdw_distributions size \\r\\n              on size.pdw_node_id = tbl.pdw_node_id \\r\\n       JOIN sys.pdw_table_mappings map \\r\\n         ON map.physical_name = tbl.name \\r\\n       JOIN sys.tables pdwtbl \\r\\n         ON pdwtbl.object_id = map.object_id \\r\\n       JOIN sys.partitions pdwpart \\r\\n         ON pdwpart.object_id = pdwtbl.object_id \\r\\n       join sys.pdw_table_distribution_properties dist \\r\\n              on pdwtbl.object_id = dist.object_id \\r\\nWHERE  dist.distribution_policy = 2 \\r\\n-- uncomment the below if you are looking for row counts for a specific table\\r\\n-- this table will also need to be added below\\r\\n-- and pdwtbl.name = 'table_name'\\r\\nGROUP  BY pdwtbl.name \\r\\nUNION ALL \\r\\nSELECT db_name() as [Database],\\r\\n    pdwtbl.name, \\r\\n  Sum(part.rows)/ sum(pdwpart.partition_number) AS CMP_ROW_COUNT, \\r\\n       sum(pdwpart.rows) /max(pdwpart.partition_number) /(select count(type) from sys.dm_pdw_nodes where type =  'COMPUTE' )\\r\\n          AS CTL_ROW_COUNT ,\\r\\n       (Sum(part.rows)/ sum(pdwpart.partition_number)) -\\r\\n       (sum(pdwpart.rows) /max(pdwpart.partition_number) /(select count(type) from sys.dm_pdw_nodes where type = 'COMPUTE'))\\r\\n          AS Count_Discrepancy\\r\\nFROM   sys.pdw_nodes_partitions part \\r\\n       JOIN sys.pdw_nodes_tables tbl \\r\\n         ON part.object_id = tbl.object_id \\r\\n            AND part.pdw_node_id = tbl.pdw_node_id \\r\\n       JOIN sys.pdw_table_mappings map \\r\\n         ON map.physical_name = tbl.name \\r\\n       JOIN sys.tables pdwtbl \\r\\n         ON pdwtbl.object_id = map.object_id \\r\\n       JOIN sys.partitions pdwpart \\r\\n         ON pdwpart.object_id = pdwtbl.object_id \\r\\n               join sys.pdw_table_distribution_properties dist \\r\\n   on pdwtbl.object_id = dist.object_id \\r\\nwhere dist.distribution_policy = 3 \\r\\n-- uncomment the below if you are looking for row counts for a specific table\\r\\n-- this table will also need to be added below\\r\\n-- and pdwtbl.name = 'table_name'\\r\\nGROUP  BY pdwtbl.name)\\r\\n\\r\\nSELECT [Table], ABS(CONVERT(INT,(CONVERT(Decimal(16,4),Count_Discrepancy)/CONVERT(Decimal(16,4),CTL_ROW_COUNT))*100)) AS Percentage_Dif FROM Row_Counts_CTE\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"20\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","EvaluationFrequency":"08:00:00","IdlePeriod":"00:00:00","MaximumAllowedDuration":"00:05:00","AntiConditionID":"fe2a858b-5b33-4121-8ec6-0f167758c5b3","MinWindowsVersion":null,"MaxWindowsVersion":null,"MinSQLServerVersion":null,"MaxSQLServerVersion":null,"MinSSASVersion":null,"MaxSSASVersion":null,"MinVmwareVersion":null,"MaxVmwareVersion":null,"MinSqlDbVersion":null,"MaxSqlDbVersion":null,"MaximumInstanceCount":100,"ColorIndicator":null,"Severity":1,"Signature":{"ConditionID":"de1eda9b-891b-4f7d-b51a-e5a684ddf570","VersionNumber":1,"AppliesToObjectTypeID":"961ba39d-5ae1-4292-9bbd-dafc269da6a8","RuleDefinition":"{\"OperationTypeID\":\"6c3d38f1-9317-4258-972a-cfee0a0d76b5\",\"Children\":[{\"OperationTypeID\":\"8fa3cd6a-960c-43bb-96e0-94092fc2c296\",\"ValueDataTypeID\":\"b35a57f5-b8f6-4e4e-9380-e9d328e3eabf\",\"Left\":{\"ValueTypeID\":\"b942fa0b-95e8-4dc8-8a0c-b4c6bc0ded34\",\"Database\":\"ContosoDW\",\"Query\":\"WITH Row_Counts_CTE\\r\\nAS\\r\\n \\r\\n(\\r\\nSELECT db_name() as [Database],\\r\\n   pdwtbl.name as [Table], \\r\\n    Sum(part.rows)/ max(pdwpart.partition_number)/8 AS CMP_ROW_COUNT, \\r\\n       sum(pdwpart.rows)/max(size.distribution_id)/max(pdwpart.partition_number)/8 AS CTL_ROW_COUNT ,\\r\\n     (Sum(part.rows)/ max(pdwpart.partition_number)/8) -  \\r\\n       (sum(pdwpart.rows)/max(size.distribution_id)/max(pdwpart.partition_number)/8) AS Count_Discrepancy \\r\\n   \\r\\nFROM   sys.pdw_nodes_partitions part \\r\\n       JOIN sys.pdw_nodes_tables tbl \\r\\n         ON part.object_id = tbl.object_id \\r\\n        AND part.pdw_node_id = tbl.pdw_node_id \\r\\n              JOIN sys.pdw_distributions size \\r\\n              on size.pdw_node_id = tbl.pdw_node_id \\r\\n       JOIN sys.pdw_table_mappings map \\r\\n         ON map.physical_name = tbl.name \\r\\n       JOIN sys.tables pdwtbl \\r\\n         ON pdwtbl.object_id = map.object_id \\r\\n       JOIN sys.partitions pdwpart \\r\\n         ON pdwpart.object_id = pdwtbl.object_id \\r\\n       join sys.pdw_table_distribution_properties dist \\r\\n              on pdwtbl.object_id = dist.object_id \\r\\nWHERE  dist.distribution_policy = 2 \\r\\n-- uncomment the below if you are looking for row counts for a specific table\\r\\n-- this table will also need to be added below\\r\\n-- and pdwtbl.name = 'table_name'\\r\\nGROUP  BY pdwtbl.name \\r\\nUNION ALL \\r\\nSELECT db_name() as [Database],\\r\\n    pdwtbl.name, \\r\\n  Sum(part.rows)/ sum(pdwpart.partition_number) AS CMP_ROW_COUNT, \\r\\n       sum(pdwpart.rows) /max(pdwpart.partition_number) /(select count(type) from sys.dm_pdw_nodes where type =  'COMPUTE' )\\r\\n          AS CTL_ROW_COUNT ,\\r\\n       (Sum(part.rows)/ sum(pdwpart.partition_number)) -\\r\\n       (sum(pdwpart.rows) /max(pdwpart.partition_number) /(select count(type) from sys.dm_pdw_nodes where type = 'COMPUTE'))\\r\\n          AS Count_Discrepancy\\r\\nFROM   sys.pdw_nodes_partitions part \\r\\n       JOIN sys.pdw_nodes_tables tbl \\r\\n         ON part.object_id = tbl.object_id \\r\\n            AND part.pdw_node_id = tbl.pdw_node_id \\r\\n       JOIN sys.pdw_table_mappings map \\r\\n         ON map.physical_name = tbl.name \\r\\n       JOIN sys.tables pdwtbl \\r\\n         ON pdwtbl.object_id = map.object_id \\r\\n       JOIN sys.partitions pdwpart \\r\\n         ON pdwpart.object_id = pdwtbl.object_id \\r\\n               join sys.pdw_table_distribution_properties dist \\r\\n   on pdwtbl.object_id = dist.object_id \\r\\nwhere dist.distribution_policy = 3 \\r\\n-- uncomment the below if you are looking for row counts for a specific table\\r\\n-- this table will also need to be added below\\r\\n-- and pdwtbl.name = 'table_name'\\r\\nGROUP  BY pdwtbl.name)\\r\\n\\r\\nSELECT [Table], ABS(CONVERT(INT,(CONVERT(Decimal(16,4),Count_Discrepancy)/CONVERT(Decimal(16,4),CTL_ROW_COUNT))*100)) AS Percentage_Dif FROM Row_Counts_CTE\",\"InstanceType\":1},\"ComparisonType\":2,\"Right\":{\"ValueTypeID\":\"07f87b7f-c063-47a2-a5be-772ba85ed827\",\"Value\":\"20\"},\"ID\":\"1\"}],\"BooleanOperationType\":0,\"ID\":\"0\"}","PublisherID":0,"PublishDateUtc":"2018-02-01T17:13:18","Rights":0,"SignatureVersion":1,"SignaturePublicKey":"<RSAKeyValue><Modulus>uzJQ9gzevXFwOgw/hkcAtD+cA/bBbD1PRzhEZCxbZ6YwjJ1c9bbfXFItLQNwnm8bdWh2k57//qbpEj5DFHOW2EAjHc2Zw5m/vACm6OzelubPS5hbWvzshlaBJKm7KrpWQpPZClx/5eVvUVzOtlz+44RRTiOszObT58acJAQwA70=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>","Signature":"pRxhU+JrbFCcZVNhRVwFNgWP7fOyhcwsv/Weyi5rzZkP1EecgWlaVQLiZ6GcAtW2pFfv8Yol18Qs+LMMByffDBGfZkhvQvbXYeQyjIemxJ2AX0vsH3VJItdPnuXF4rvOVGS1MPjoJroP41yL7CFil4kfK3flmH/ow3cdtMjOXak=","IsSelfPublishedCondition":true},"Tags":"ADW","Areas":[],"ConditionSystemVersion":3,"MinDBSchemaVersion":null,"MaxDBSchemaVersion":null,"Items":[]}